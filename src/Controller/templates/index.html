<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        /* CSS style to remove bullet points from the list */
        ul {
          list-style-type: none;
        }
        .container { 
            border:2px solid #ccc; 
            width:500px; 
            height: 500px; 
            overflow-y: scroll; 
            padding-left: 10px;
        }
        .container li{
            display:flex;
            align-items: center;
            margin: 5px 0;
        }
      </style>
</head>

<body>
    <h1>
        OMER'S ROOM LIGHTS
    </h1>
    
    <label>
        <input type="radio" id="LIGHTS_OFF" name="light_setting" value="LIGHTS_OFF">
        <i>Lights Off</i>
    </label>
    <br/>
    <label>
        <input type="radio" id="SPOTIFY_LIGHTS_ON" name="light_setting" value="SPOTIFY_LIGHTS_ON">
        <i>Spotify Lights On</i>
    </label>
    <br/>
    <label>
        <input type="radio" id="ANIMATION_LIGHTS_ON" name="light_setting" value="ANIMATION_LIGHTS_ON">
        <i>Animations On</i>
    </label>
    <div>
        <form id="uploadForm">
            <input type="file" id="fileInput" name="file" />
            <button type="button" onclick="upload_animation()">Upload</button>
        </form>    
    </div>
    <br/>
    
    <form id="animation_form" action="/animation_files">
        <div class=container>
            <button type="button" name="dumb" id="select_deselect_all" value="select" onclick="check_uncheck_all_boxes()">Select All</button>
            <ul id="animations_checkboxes">
                {% for fileName in fileNames %}
                    <li>
                        <input type="checkbox" name="selected_files" value="{{ fileName }}" id="fileName_{{ loop.index }}"
                        {% if fileName in enabledFiles %} checked {% endif %} onclick="all_boxes_checked()"> 
                        <label for="fileName_{{ loop.index }}">{{ fileName }}</label>  
                    </li>
                {% endfor %}
            </ul>
        </div>
        <button type="submit" name="action" value="select" formmethod="post">Select Animations / Set Duration</button>
        <button type="submit" name="action" value="delete" formmethod="post">Delete Animations</button>
        <button type="submit" name="action" value="download" formmethod="get">Download Animation Files</button>
        <br/>
        <input type="number" name="animation_duration" value="{{ duration }}" step="0.01"><span> Animation Duration (sec)</span>
    </form>
</body>
</html>

<script>
    function submit_animation_form(action){
        const form = document.getElementById('animation_form')
        const formData = new FormData(form)

        formData.append('action', action)

        fetch('/animation_files', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            response.text()
            setTimeout(function(){
              window.location.href = "/"
            },
            1000)
        })
        .then(data=> {
            console.log(data)
            setTimeout(function(){
              window.location.href = "/"
            },
            1000)
        })
        .catch(error=> {
            console.error("Error: ", error)
            setTimeout(function(){
              window.location.href = "/"
            },
            1000)
        })
    }
    
    function upload_animation(){
        const files = document.getElementById('fileInput')
        const file = fileInput.files[0]

        if(!file){
            alert('No file was selected, please select a file.')
            return;
        }
        
        const formData = new FormData()
        formData.append('file', file)
        formData.append('action', 'upload')
        
        fetch('/animation_files', {
            method: 'POST',
            body: formData
        }).then(response => {
            if(response.ok){
                alert('The file was uploaded')
            }
            else{
                alert('There was an error uploading the file, please try again')
            }

            setTimeout(function(){
                window.location.href = "/"
            },
            1000)
        }).catch(error => {
            alert('There was an error uploading the file.')

            setTimeout(function(){
              window.location.href = "/"
            },
            1000)
        })
    }

    function on_radio_click(){
        setting_to_send = null

        if(document.getElementById("LIGHTS_OFF").checked){

            document.getElementById("SPOTIFY_LIGHTS_ON").checked = false
            document.getElementById("ANIMATION_LIGHTS_ON").checked = false
            setting_to_send = "LIGHTS_OFF"    
        }
        else if(document.getElementById("SPOTIFY_LIGHTS_ON").checked){

            document.getElementById("LIGHTS_OFF").checked = false
            document.getElementById("ANIMATION_LIGHTS_ON").checked = false
            setting_to_send = "SPOTIFY_LIGHTS_ON"
        }
        else if(document.getElementById("ANIMATION_LIGHTS_ON").checked){

            document.getElementById("LIGHTS_OFF").checked = false
            document.getElementById("SPOTIFY_LIGHTS_ON").checked = false
            setting_to_send = "ANIMATION_LIGHTS_ON"
        }

        fetch("http://192.168.1.80:9090/light_setting", {
            method: "POST",
            headers: {
                "Content-Type": "application/json", // Set the appropriate content type for your data
            },
            body: JSON.stringify({ light_setting: setting_to_send }), // Convert your data to JSON if needed
        })
    }
    
    const buttons = document.getElementsByName("light_setting") 
    for(let i = 0; i < buttons.length; i++){
        buttons[i].addEventListener("click", on_radio_click)
    }

    function all_boxes_checked(){
        const checkbox_elements = document.getElementById("animations_checkboxes").getElementsByTagName("input")
        let all_checked = true
        for(let i = 0; i < checkbox_elements.length; i++){
            all_checked = all_checked && checkbox_elements[i].checked
        }

        select_deselect_all_button = document.getElementById("select_deselect_all")
        if(all_checked){
            select_deselect_all_button.innerHTML = "Deselect All"
            select_deselect_all_button.value = "deselect"
        }
        else{
            select_deselect_all_button.innerHTML = "Select All"
            select_deselect_all_button.value = "select"
        }
    }

    function check_uncheck_all_boxes(){
        const checkbox_elements = document.getElementById("animations_checkboxes").getElementsByTagName("input")
        const select_deselect_all_button = document.getElementById("select_deselect_all")

        const val_to_set_checkboxes_to = select_deselect_all_button.value == "select"
        
        for(let i = 0; i < checkbox_elements.length; i++){
            checkbox_elements[i].checked = val_to_set_checkboxes_to
        }

        all_boxes_checked()
    }
    all_boxes_checked()
</script>